<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Generador de Recibos - Asamblea Jerovia N°9</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      :root {
        --color-primario: #e91e63;
        --color-secundario: #f8bbd0;
        --color-fondo: #fff5f7;
        --color-texto: #333;
        --color-rosa-claro: #fce4ec; /* Nuevo color para el recuadro de firma temporal */
        --color-botones-rosa: #f06292; /* Rosa un poco más claro para los botones */
        --color-rojo-boton: #f44336; /* Rojo para el botón sin firma */
        --color-verde-boton: #4caf50; /* Verde para el botón Generar Recibo */
      }

      body {
        font-family: "Roboto", sans-serif;
        background: linear-gradient(135deg, var(--color-fondo), #ffffff);
        color: var(--color-texto);
        margin: 0;
        padding: 20px;
        min-height: 100vh; /* Ajustado para mejor visualización */
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      h1,
      h2 {
        font-family: "Playfair Display", serif;
        color: var(--color-primario);
        text-align: center;
        font-weight: 700;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 400;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--color-secundario);
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
      }

      button {
        background: var(--color-primario);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
        margin: 5px 0;
      }

      button:hover {
        background: #c2185b;
        transform: translateY(-2px);
      }

      /* Estilos para los nuevos botones */
      #btn-firma-autoridad,
      #btn-recibo-sin-firma {
        background-color: var(--color-botones-rosa);
      }

      #btn-firma-autoridad:hover {
        background-color: #e91e63; /* Más oscuro al pasar el ratón */
      }

      #btn-recibo-sin-firma {
        background-color: var(--color-rojo-boton);
      }

      #btn-recibo-sin-firma:hover {
        background-color: #d32f2f; /* Más oscuro al pasar el ratón */
      }

      #btn-generar {
        background-color: var(--color-verde-boton);
        font-size: 18px; /* Más llamativo */
        padding: 15px 25px;
      }

      #btn-generar:hover {
        background-color: #388e3c; /* Más oscuro al pasar el ratón */
      }

      .logo-preview {
        display: flex;
        justify-content: space-between;
        margin: 20px 0;
        gap: 10px;
      }

      .logo-preview > div {
        flex: 1;
        text-align: center;
      }

      .logo-preview img {
        max-width: 100%;
        max-height: 80px;
        object-fit: contain;
        border: 1px dashed #ccc;
        margin-top: 10px;
        display: none;
      }

      .firma-preview {
        text-align: center;
        margin-top: 20px;
      }

      .firma-preview img {
        max-width: 200px;
        max-height: 80px;
        border: 1px dashed #ccc;
        margin-top: 10px;
        display: none;
      }

      .preview-container {
        position: relative;
      }

      .remove-btn {
        position: absolute;
        top: 0;
        right: 0;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 12px;
        cursor: pointer;
        display: none;
      }

      .rainbow-effect {
        background: linear-gradient(
          45deg,
          #e91e63,
          #9c27b0,
          #3f51b5,
          #03a9f4,
          #009688,
          #8bc34a,
          #ffeb3b,
          #ff9800
        );
        background-size: 400% 400%;
        animation: rainbow 15s ease infinite;
        height: 4px;
        margin: 10px 0;
        border-radius: 2px;
      }

      @keyframes rainbow {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .button-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
      }

      .numero-recibo-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .numero-recibo-container input {
        width: 100px;
      }

      .checkbox-container {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 10px;
      }

      .custom-option-container {
        background-color: var(--color-rosa-claro);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px dashed var(--color-primario);
        display: none; /* Oculto por defecto */
        flex-direction: column;
        gap: 10px;
        align-items: center; /* Centra los elementos internos */
        text-align: center;
      }

      .custom-option-container p {
        margin: 0;
        font-weight: bold;
        color: var(--color-primario);
      }

      .custom-option-container img {
        max-width: 150px;
        max-height: 60px;
        object-fit: contain;
        border: 1px dashed #ccc;
        margin-top: 5px;
        display: none;
      }

      .custom-option-container .remove-btn {
        position: static; /* Para que no flote y se alinee en el flexbox */
        margin-left: auto;
        margin-right: auto;
        display: none;
      }

      .custom-option-container input[type="text"] {
        width: calc(100% - 20px); /* Ajuste de ancho */
        max-width: 300px;
        margin: 0 auto;
        text-align: center;
      }

      .custom-option-container button {
        background-color: var(--color-botones-rosa);
      }
      .custom-option-container button:hover {
        background-color: #e91e63;
      }

      .divider-line {
        border-top: 1px dashed #ccc;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Generador de Recibos</h1>
      <div class="rainbow-effect"></div>
      <h2>Asamblea Jerovia N°9</h2>

      <div class="form-group">
        <div class="numero-recibo-container">
          <label for="numero-recibo">Número de Recibo:</label>
          <input type="number" id="numero-recibo" min="1" step="1" />
          <div class="checkbox-container">
            <input type="checkbox" id="auto-numero" checked />
            <label for="auto-numero">Auto-incrementar</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" required />
      </div>

      <div class="form-group">
        <label for="monto">Monto (Gs):</label>
        <input type="text" id="monto" required />
      </div>

      <div class="form-group">
        <label for="motivo">Concepto:</label>
        <input type="text" id="motivo" required />
      </div>

      <div class="form-group">
        <label for="fecha">Fecha:</label>
        <input type="date" id="fecha" required />
      </div>

      <div class="form-group">
        <label>Logos:</label>
        <div class="logo-preview">
          <div class="preview-container">
            <button type="button" id="btn-logo-izq">
              Seleccionar Logo Izquierdo
            </button>
            <img id="preview-logo-izq" alt="Logo izquierdo" />
            <button class="remove-btn" id="remove-logo-izq">×</button>
          </div>
          <div class="preview-container">
            <button type="button" id="btn-logo-der">
              Seleccionar Logo Derecho
            </button>
            <img id="preview-logo-der" alt="Logo derecho" />
            <button class="remove-btn" id="remove-logo-der">×</button>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Firma:</label>
        <div class="firma-preview preview-container">
          <button type="button" id="btn-firma">Seleccionar Firma</button>
          <img id="preview-firma" alt="Firma" />
          <button class="remove-btn" id="remove-firma">×</button>
        </div>
      </div>

      <div class="divider-line"></div>

      <div class="button-group">
        <button type="button" id="btn-firma-autoridad">
          Recibo firmado por una autoridad
        </button>
        <div id="firma-autoridad-container" class="custom-option-container">
          <p>Firma temporal para este recibo</p>
          <button type="button" id="btn-firma-temporal">
            Subir Firma Temporal
          </button>
          <img id="preview-firma-temporal" alt="Firma temporal" />
          <button class="remove-btn" id="remove-firma-temporal">×</button>
          <input
            type="text"
            id="cargo-firma-temporal"
            placeholder="Ingrese el cargo de quien firma este documento, evita utilizar sufijos el/la o nombres propios"
          />
        </div>

        <button type="button" id="btn-recibo-sin-firma">
          Recibo sin firma virtual
        </button>
        <div id="recibo-sin-firma-container" class="custom-option-container">
          <p>Este recibo se generará sin imagen de firma</p>
          <input
            type="text"
            id="cargo-firma-manual"
            placeholder="Ingrese el cargo de quien firmará presencialmente (opcional)"
          />
        </div>

        <button type="button" id="btn-generar">Generar Recibo</button>
      </div>
    </div>

    <script>
      // Variables globales
      const { jsPDF } = window.jspdf;

      // Helper para convertir número a formato de moneda con puntos y comas
      function formatMonto(monto) {
        // Asegurarse de que el monto sea un número antes de formatear
        const numMonto = parseFloat(
          monto.replace(/\./g, "").replace(",", ".")
        ); // Eliminar puntos y cambiar coma por punto si existe
        if (isNaN(numMonto)) {
          return monto; // Devolver el monto original si no es un número válido
        }
        return numMonto.toLocaleString("es-PY", {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
      }

      // Helper para formatear fecha a "D de M de AAAA" (ej. 17 de Julio de 2025)
      function formatFechaEnPalabras(fechaIso) {
        try {
          const [year, month, day] = fechaIso.split("-").map(Number);
          const date = new Date(year, month - 1, day);
          const options = { day: "numeric", month: "long", year: "numeric" };
          return date.toLocaleDateString("es-PY", options);
        } catch (e) {
          console.error("Error al formatear fecha en palabras:", e);
          return fechaIso; // Fallback al formato original si hay error
        }
      }

      // Helper para formatear fecha a "DD/MM/AAAA"
      function formatFechaDDMMYYYY(fechaIso) {
        try {
          const [year, month, day] = fechaIso.split("-").map(Number);
          return `${String(day).padStart(2, "0")}/${String(
            month
          ).padStart(2, "0")}/${year}`;
        } catch (e) {
          console.error("Error al formatear fecha DD/MM/AAAA:", e);
          return fechaIso; // Fallback al formato original si hay error
        }
      }

      // Variable global para almacenar el nombre/cargo de la firma cuando no hay imagen
      let firmaTextoPersonalizado = "";
      // Variables para la firma temporal
      let firmaTemporalData = null;
      let cargoFirmaTemporal = "";

      // Variable para la firma manual (sin imagen)
      let cargoFirmaManual = "";
      let isReciboSinFirma = false; // Estado para saber si se generará sin firma virtual

      // Constantes para las claves de localStorage
      const STORAGE_KEYS = {
        LOGO_IZQUIERDO: "logoIzquierdo",
        LOGO_DERECHO: "logoDerecho",
        FIRMA_GUARDADA: "firma", // Renombrado para evitar conflicto con firmaTemporalData
        NUMERO_RECIBO: "numeroRecibo",
        FIRMA_TEXTO_PERSONALIZADO: "firmaTextoPersonalizado",
      };

      // Inicialización
      document.addEventListener("DOMContentLoaded", function () {
        // Cargar número de recibo persistente
        const savedNumero = localStorage.getItem(STORAGE_KEYS.NUMERO_RECIBO);
        const initialNumero = savedNumero ? parseInt(savedNumero) : 1;
        document.getElementById("numero-recibo").value = initialNumero;

        // Establecer fecha actual por defecto (formato YYYY-MM-DD)
        const today = new Date();
        const day = String(today.getDate()).padStart(2, "0");
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const year = today.getFullYear();
        document.getElementById("fecha").value = `${year}-${month}-${day}`;

        // Cargar imágenes guardadas
        cargarImagenGuardada(
          STORAGE_KEYS.LOGO_IZQUIERDO,
          "preview-logo-izq",
          "remove-logo-izq"
        );
        cargarImagenGuardada(
          STORAGE_KEYS.LOGO_DERECHO,
          "preview-logo-der",
          "remove-logo-der"
        );
        cargarImagenGuardada(
          STORAGE_KEYS.FIRMA_GUARDADA,
          "preview-firma",
          "remove-firma"
        );

        // Cargar texto de firma personalizado (si existe)
        const savedFirmaTexto = localStorage.getItem(
          STORAGE_KEYS.FIRMA_TEXTO_PERSONALIZADO
        );
        if (savedFirmaTexto) {
          firmaTextoPersonalizado = savedFirmaTexto;
        }

        // Configurar listeners para botones de imágenes
        document
          .getElementById("btn-logo-izq")
          .addEventListener("click", function () {
            seleccionarImagen(
              STORAGE_KEYS.LOGO_IZQUIERDO,
              "preview-logo-izq",
              "remove-logo-izq"
            );
          });

        document
          .getElementById("btn-logo-der")
          .addEventListener("click", function () {
            seleccionarImagen(
              STORAGE_KEYS.LOGO_DERECHO,
              "preview-logo-der",
              "remove-logo-der"
            );
          });

        document.getElementById("btn-firma").addEventListener("click", function () {
          seleccionarImagen(
            STORAGE_KEYS.FIRMA_GUARDADA,
            "preview-firma",
            "remove-firma"
          );
        });

        document
          .getElementById("remove-logo-izq")
          .addEventListener("click", function () {
            eliminarImagen(
              STORAGE_KEYS.LOGO_IZQUIERDO,
              "preview-logo-izq",
              "remove-logo-izq"
            );
          });

        document
          .getElementById("remove-logo-der")
          .addEventListener("click", function () {
            eliminarImagen(
              STORAGE_KEYS.LOGO_DERECHO,
              "preview-logo-der",
              "remove-logo-der"
            );
          });

        document.getElementById("remove-firma").addEventListener("click", function () {
          eliminarImagen(
            STORAGE_KEYS.FIRMA_GUARDADA,
            "preview-firma",
            "remove-firma"
          );
          // También borrar el texto de firma personalizado si se elimina la imagen
          firmaTextoPersonalizado = "";
          localStorage.removeItem(STORAGE_KEYS.FIRMA_TEXTO_PERSONALIZADO);
        });

        // --- Nuevos listeners para las opciones de firma ---
        const firmaAutoridadContainer = document.getElementById(
          "firma-autoridad-container"
        );
        const reciboSinFirmaContainer = document.getElementById(
          "recibo-sin-firma-container"
        );
        const cargoFirmaTemporalInput = document.getElementById(
          "cargo-firma-temporal"
        );
        const cargoFirmaManualInput = document.getElementById(
          "cargo-firma-manual"
        );

        document
          .getElementById("btn-firma-autoridad")
          .addEventListener("click", function () {
            firmaAutoridadContainer.style.display = "flex";
            reciboSinFirmaContainer.style.display = "none";
            isReciboSinFirma = false; // Desactiva el modo sin firma
            cargoFirmaManual = ""; // Limpia el cargo de firma manual
            cargoFirmaManualInput.value = ""; // Limpiar el input

            // Si hay firma temporal guardada, cargarla
            if (firmaTemporalData) {
              document.getElementById("preview-firma-temporal").src =
                firmaTemporalData;
              document.getElementById("preview-firma-temporal").style.display =
                "block";
              document.getElementById("remove-firma-temporal").style.display =
                "block";
            } else {
              document.getElementById("preview-firma-temporal").style.display =
                "none";
              document.getElementById("remove-firma-temporal").style.display =
                "none";
            }
            cargoFirmaTemporalInput.value = cargoFirmaTemporal;
          });

        document
          .getElementById("btn-recibo-sin-firma")
          .addEventListener("click", function () {
            reciboSinFirmaContainer.style.display = "flex";
            firmaAutoridadContainer.style.display = "none";
            isReciboSinFirma = true; // Activa el modo sin firma
            firmaTemporalData = null; // Limpia la firma temporal
            cargoFirmaTemporal = ""; // Limpia el cargo de firma temporal
            document.getElementById("preview-firma-temporal").style.display =
              "none"; // Ocultar preview
            document.getElementById("remove-firma-temporal").style.display =
              "none"; // Ocultar botón de remover
            cargoFirmaTemporalInput.value = ""; // Limpiar el input
            cargoFirmaManualInput.value = cargoFirmaManual; // Restaurar el cargo manual si había
          });

        document
          .getElementById("btn-firma-temporal")
          .addEventListener("click", function () {
            seleccionarImagenTemporal(
              "preview-firma-temporal",
              "remove-firma-temporal"
            );
          });

        document
          .getElementById("remove-firma-temporal")
          .addEventListener("click", function () {
            eliminarImagenTemporal(
              "preview-firma-temporal",
              "remove-firma-temporal"
            );
          });

        cargoFirmaTemporalInput.addEventListener("input", function () {
          cargoFirmaTemporal = this.value.trim();
        });

        cargoFirmaManualInput.addEventListener("input", function () {
          cargoFirmaManual = this.value.trim();
        });

        // Configurar generación de recibo (AHORA ES ASÍNCRONA)
        document
          .getElementById("btn-generar")
          .addEventListener("click", async function () {
            await generarRecibo(); // Esperar a que se complete la generación
          });

        // Configurar auto-incremento
        document
          .getElementById("auto-numero")
          .addEventListener("change", function () {
            if (this.checked) {
              const currentNum = parseInt(
                document.getElementById("numero-recibo").value
              );
              localStorage.setItem(STORAGE_KEYS.NUMERO_RECIBO, currentNum.toString());
            }
          });
      });

      function cargarImagenGuardada(tipo, previewId, removeBtnId) {
        const imgData = localStorage.getItem(tipo);
        if (imgData) {
          const preview = document.getElementById(previewId);
          preview.src = imgData;
          preview.style.display = "block";
          document.getElementById(removeBtnId).style.display = "block";
        }
      }

      function seleccionarImagen(tipo, previewId, removeBtnId) {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";

        input.onchange = function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (event) {
            localStorage.setItem(tipo, event.target.result);
            const preview = document.getElementById(previewId);
            preview.src = event.target.result;
            preview.style.display = "block";
            document.getElementById(removeBtnId).style.display = "block";
            // Si se selecciona una firma, borrar el texto personalizado y resetear opciones temporales
            if (tipo === STORAGE_KEYS.FIRMA_GUARDADA) {
              firmaTextoPersonalizado = "";
              localStorage.removeItem(STORAGE_KEYS.FIRMA_TEXTO_PERSONALIZADO);
              // Desactivar y ocultar opciones de firma temporal/sin firma
              firmaTemporalData = null;
              cargoFirmaTemporal = "";
              isReciboSinFirma = false;
              cargoFirmaManual = "";
              document.getElementById("firma-autoridad-container").style.display =
                "none";
              document.getElementById("recibo-sin-firma-container").style.display =
                "none";
              document.getElementById("preview-firma-temporal").style.display =
                "none";
              document.getElementById("remove-firma-temporal").style.display =
                "none";
              document.getElementById("cargo-firma-temporal").value = "";
              document.getElementById("cargo-firma-manual").value = "";
            }
          };
          reader.readAsDataURL(file);
        };

        input.click();
      }

      function eliminarImagen(tipo, previewId, removeBtnId) {
        localStorage.removeItem(tipo);
        document.getElementById(previewId).style.display = "none";
        document.getElementById(removeBtnId).style.display = "none";
        // Si se elimina la firma, limpiar el texto personalizado
        if (tipo === STORAGE_KEYS.FIRMA_GUARDADA) {
          firmaTextoPersonalizado = "";
          localStorage.removeItem(STORAGE_KEYS.FIRMA_TEXTO_PERSONALIZADO);
        }
      }

      // Funciones para la firma temporal
      function seleccionarImagenTemporal(previewId, removeBtnId) {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";

        input.onchange = function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (event) {
            firmaTemporalData = event.target.result; // No guardar en localStorage
            const preview = document.getElementById(previewId);
            preview.src = event.target.result;
            preview.style.display = "block";
            document.getElementById(removeBtnId).style.display = "block";
            // Asegurarse de que la firma guardada no se use si hay temporal
            eliminarImagen(
              STORAGE_KEYS.FIRMA_GUARDADA,
              "preview-firma",
              "remove-firma"
            ); // Eliminar la firma guardada
          };
          reader.readAsDataURL(file);
        };
        input.click();
      }

      function eliminarImagenTemporal(previewId, removeBtnId) {
        firmaTemporalData = null; // Eliminar la firma temporal
        document.getElementById(previewId).style.display = "none";
        document.getElementById(removeBtnId).style.display = "none";
        document.getElementById("cargo-firma-temporal").value = ""; // Limpiar el cargo
        cargoFirmaTemporal = "";
      }

      async function generarRecibo() {
        // Validar datos
        const nombre = document.getElementById("nombre").value.trim();
        const monto = document.getElementById("monto").value.trim();
        const motivo = document.getElementById("motivo").value.trim();
        const fechaInput = document.getElementById("fecha");
        const fecha = fechaInput.value; // Formato YYYY-MM-DD
        const numeroReciboInput = document.getElementById("numero-recibo");
        let numeroRecibo = parseInt(numeroReciboInput.value);
        const autoIncrementar = document.getElementById("auto-numero").checked;

        if (!nombre || !monto || !motivo || !fecha || isNaN(numeroRecibo)) {
          alert("Por favor complete todos los campos requeridos");
          return;
        }

        // --- Lógica de la firma principal ---
        let firmaDataParaPDF = null;
        let firmaTextoParaPDF = "Tesorera"; // Valor por defecto

        if (isReciboSinFirma) {
          // Opción "Recibo sin firma virtual" seleccionada
          firmaDataParaPDF = null; // No hay imagen de firma
          firmaTextoParaPDF = cargoFirmaManual || "Tesorera"; // Usar el cargo manual o Tesorera
        } else if (firmaTemporalData) {
          // Opción "Recibo firmado por una autoridad" seleccionada con imagen temporal
          firmaDataParaPDF = firmaTemporalData;
          firmaTextoParaPDF = cargoFirmaTemporal || "Autoridad Firmante"; // Usar cargo temporal o Autoridad Firmante
        } else {
          // Usar la firma guardada o el texto personalizado si no hay imagen
          firmaDataParaPDF = localStorage.getItem(STORAGE_KEYS.FIRMA_GUARDADA);
          if (firmaDataParaPDF) {
            firmaTextoParaPDF = "Tesorera"; // Por defecto si hay imagen guardada
          } else {
            // Si no hay imagen guardada y no se usaron las nuevas opciones, preguntar por el texto
            let confirmacionSinFirma = confirm("No se ha seleccionado firma ¿esto es correcto?");
            if (!confirmacionSinFirma) {
              return;
            } else {
              let textoIngresado = prompt(
                "¿Quién debe firmar este documento?\n\nFavor completar este campo sin agregar sufijos (el/la), en lo posible solo especificar su cargo:",
                firmaTextoPersonalizado || ""
              );
              if (textoIngresado !== null) {
                firmaTextoPersonalizado = textoIngresado.trim() || "Tesorera";
                localStorage.setItem(
                  STORAGE_KEYS.FIRMA_TEXTO_PERSONALIZADO,
                  firmaTextoPersonalizado
                );
              } else {
                firmaTextoPersonalizado = firmaTextoPersonalizado || "Tesorera";
              }
              firmaTextoParaPDF = firmaTextoPersonalizado;
            }
          }
        }
        // --- Fin Lógica de la firma ---

        // Formatear monto y fecha para el contenido
        const montoFormateado = formatMonto(monto);
        const fechaEnPalabras = formatFechaEnPalabras(fecha);
        const fechaDDMMYYYY = formatFechaDDMMYYYY(fecha); // Nueva variable para formato DD/MM/YYYY

        // Generar número de recibo formateado
        const numeroCompleto = `RJ9-${numeroRecibo.toString().padStart(4, "0")}`;

        // Actualizar número para el próximo recibo si está en modo auto-incremento
        if (autoIncrementar) {
          numeroRecibo++;
          numeroReciboInput.value = numeroRecibo;
          localStorage.setItem(STORAGE_KEYS.NUMERO_RECIBO, numeroRecibo.toString());
        }

        // Crear PDF
        const doc = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: "a4",
        });

        // Configuración de página
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        const reciboHeight = (pageHeight - margin * 3) / 2;

        // Fuentes
        doc.setFont("helvetica");

        // Generar primer recibo (original)
        await generarReciboIndividual(doc, {
          x: margin,
          y: margin,
          width: pageWidth - margin * 2,
          height: reciboHeight,
          nombre,
          monto: montoFormateado,
          motivo,
          fecha: fechaDDMMYYYY, // Usar el nuevo formato para el PDF
          fechaEnPalabras,
          numeroRecibo: numeroCompleto,
          esCopia: false,
          firmaData: firmaDataParaPDF, // Pasar los datos de la firma decididos
          firmaTexto: firmaTextoParaPDF, // Pasar el texto de la firma decidida
          isSinFirma: isReciboSinFirma, // Indicar si es un recibo sin firma virtual
        });

        // Línea punteada para cortar
        doc.setDrawColor(150, 150, 150);
        doc.setLineWidth(0.2);
        doc.setLineDash([2, 2], 0);
        doc.line(
          margin,
          margin * 1.5 + reciboHeight,
          pageWidth - margin,
          margin * 1.5 + reciboHeight
        );
        doc.setLineDash([], 0);

        // Generar segundo recibo (copia)
        await generarReciboIndividual(doc, {
          x: margin,
          y: margin * 2 + reciboHeight,
          width: pageWidth - margin * 2,
          height: reciboHeight,
          nombre,
          monto: montoFormateado,
          motivo,
          fecha: fechaDDMMYYYY, // Usar el nuevo formato para el PDF
          fechaEnPalabras,
          numeroRecibo: numeroCompleto,
          esCopia: true,
          firmaData: firmaDataParaPDF, // Pasar los datos de la firma decididos
          firmaTexto: firmaTextoParaPDF, // Pasar el texto de la firma decidida
          isSinFirma: isReciboSinFirma, // Indicar si es un recibo sin firma virtual
        });

        // Guardar PDF (Ahora se abre un diálogo para elegir la carpeta)
        try {
          const pdfBlob = doc.output("blob");
          // Nuevo nombre del archivo: "numero de recibo - nombre - fecha.pdf"
          const suggestedFileName = `${numeroCompleto} - ${nombre} - ${fechaDDMMYYYY}.pdf`;

          const fileHandle = await window.showSaveFilePicker({
            suggestedName: suggestedFileName,
            types: [
              {
                description: "Archivos PDF",
                accept: { "application/pdf": [".pdf"] },
              },
            ],
          });
          const writableStream = await fileHandle.createWritable();
          await writableStream.write(pdfBlob);
          await writableStream.close();
          console.log("PDF guardado en la ubicación elegida por el usuario.");
        } catch (error) {
          if (error.name === "AbortError") {
            console.log("Guardado de PDF cancelado por el usuario.");
          } else {
            console.error("Error al guardar el PDF:", error);
            alert(
              "No se pudo guardar el PDF. ¿Quizás el navegador no sopporta la selección de carpeta o el usuario canceló la operación?"
            );
          }
        }
      }

      // Función para obtener las dimensiones naturales de una imagen (async)
      function getNaturalImageDimensions(imgSrc) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            resolve({ width: img.naturalWidth, height: img.naturalHeight });
          };
          img.onerror = () => {
            console.error("Error cargando imagen para dimensiones:", imgSrc);
            resolve({ width: 0, height: 0 }); // Devolver 0 para evitar errores
          };
          img.src = imgSrc;
        });
      }

      async function generarReciboIndividual(doc, options) {
        const {
          x,
          y,
          width,
          height,
          nombre,
          monto,
          motivo,
          fechaEnPalabras,
          numeroRecibo,
          esCopia,
          fecha,
          firmaData, // Datos de la firma a usar (puede ser null)
          firmaTexto, // Texto de la firma a usar
          isSinFirma, // Nuevo: booleano para indicar si no hay firma virtual
        } = options;

        // Estilo del recibo
        doc.setDrawColor(233, 30, 99);
        doc.setLineWidth(0.5);
        doc.rect(x, y, width, height);

        const marginInterno = 10;
        const logoMaxHeightPdf = 25; // Alto máximo para logos en PDF (mm)
        const logoMaxWidthIzqPdf = 80; // Ancho máximo para logo IZQUIERDO - Aumentado
        const logoMaxWidthDerPdf = 65; // Ancho máximo para logo DERECHO

        // Variables para calcular dimensiones de logos
        let logoHeightIzq = 0;
        let logoWidthIzq = 0;
        let logoHeightDer = 0;
        let logoWidthDer = 0;

        const logoIzqData = localStorage.getItem(STORAGE_KEYS.LOGO_IZQUIERDO);
        const logoDerData = localStorage.getItem(STORAGE_KEYS.LOGO_DERECHO);

        // Calcular dimensiones para logo izquierdo
        if (logoIzqData) {
          const dims = await getNaturalImageDimensions(logoIzqData);
          if (dims.width > 0 && dims.height > 0) {
            const ratio = dims.width / dims.height;
            logoHeightIzq = logoMaxHeightPdf;
            logoWidthIzq = logoHeightIzq * ratio;
            if (logoWidthIzq > logoMaxWidthIzqPdf) {
              logoWidthIzq = logoMaxWidthIzqPdf;
              logoHeightIzq = logoWidthIzq / ratio;
            }
          }
        }

        // Calcular dimensiones para logo derecho
        if (logoDerData) {
          const dims = await getNaturalImageDimensions(logoDerData);
          if (dims.width > 0 && dims.height > 0) {
            const ratio = dims.width / dims.height;
            logoHeightDer = logoMaxHeightPdf;
            logoWidthDer = logoHeightDer * ratio;
            if (logoWidthDer > logoMaxWidthDerPdf) {
              logoWidthDer = logoMaxWidthDerPdf;
              logoHeightDer = logoWidthDer / ratio;
            }
          }
        }

        // Determinar la altura máxima de los logos para centrado y posición
        const actualLogoHeight = Math.max(logoHeightIzq, logoHeightDer);

        // La altura total del bloque superior (logos + título)
        const titleTextHeight = 16 + 13 + 3; // Altura aproximada de "Asamblea Jerovia N°9" (16pt) + espacio + "RECIBO OFICIAL" (13pt)
        const topBlockTotalHeight = Math.max(actualLogoHeight, titleTextHeight);

        // Centro vertical del bloque superior, ligeramente más arriba
        const centerOfTopBlockY = y + marginInterno + topBlockTotalHeight / 2 - 3; // Mover 3mm más arriba

        // Dibujar logo izquierdo
        if (logoIzqData && logoWidthIzq > 0 && logoHeightIzq > 0) {
          const logoLeftX = x + marginInterno;
          const logoLeftY = centerOfTopBlockY - logoHeightIzq / 2;
          doc.addImage(
            logoIzqData,
            logoIzqData.startsWith("data:image/png") ? "PNG" : "JPEG",
            logoLeftX,
            logoLeftY,
            logoWidthIzq,
            logoHeightIzq,
            undefined,
            "FAST"
          );
        }

        // Dibujar logo derecho
        if (logoDerData && logoWidthDer > 0 && logoHeightDer > 0) {
          const logoRightX = x + width - marginInterno - logoWidthDer;
          const logoRightY = centerOfTopBlockY - logoHeightDer / 2;
          doc.addImage(
            logoDerData,
            logoDerData.startsWith("data:image/png") ? "PNG" : "JPEG",
            logoRightX,
            logoRightY,
            logoWidthDer,
            logoHeightDer,
            undefined,
            "FAST"
          );
        }

        // Título principal: Dividido en dos líneas y centrado entre logos
        const titleCenterX = x + width / 2;
        const titleLine1Y = centerOfTopBlockY - titleTextHeight / 2 + 16 / 2 - 1; // Ajuste para el centro vertical
        const titleLine2Y = titleLine1Y + 8; // Espacio de 8mm entre líneas

        doc.setFont(undefined, "bold");
        doc.setTextColor(233, 30, 99);

        doc.setFontSize(16); // Tamaño para "Asamblea Jerovia N°9"
        doc.text("Asamblea Jerovia N°9", titleCenterX, titleLine1Y, {
          align: "center",
        });

        doc.setFontSize(13); // Tamaño para "RECIBO OFICIAL"
        doc.setFont(undefined, "normal"); // Volver a normal para la segunda línea
        doc.text("RECIBO OFICIAL", titleCenterX, titleLine2Y, {
          align: "center",
        });

        // Posición del número de recibo y fecha
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, "normal");

        // Número de recibo: Inmediatamente debajo del bloque superior (logos + títulos)
        const numReciboY = y + marginInterno + topBlockTotalHeight + 5;
        doc.text(numeroRecibo, x + marginInterno, numReciboY, {
          align: "left",
        });

        // Fecha: Ligeramente más abajo que el número de recibo, alineada a la derecha
        const fechaY = numReciboY + 5; // 5mm más abajo que el número de recibo
        doc.text(fecha, x + width - marginInterno, fechaY, {
          align: "right",
        });

        // --- Contenido del Recibo (Texto) ---
        const contenidoX = x + marginInterno;
        const contenidoWidth = width - marginInterno * 2;
        const textoContenido = `En fecha ${fechaEnPalabras} la asamblea Jerovia N°9 recibe de ${nombre} la suma de Gs. ${monto} en concepto de ${motivo}.`;

        // Posición y dimensiones para la firma
        const firmaMaxWidth = 50; // Ancho máximo para la firma (mm)
        const firmaMaxHeight = 20; // Alto máximo para la firma (mm)
        const firmaLineHeight = 0.5; // Grosor de la línea de firma
        const firmaTextoLineHeight = 5; // Espacio para el texto de la firma
        const firmaBlockHeight = (firmaData ? firmaMaxHeight : firmaLineHeight) + firmaTextoLineHeight + 5; // Altura total del bloque de firma (imagen o línea + texto)
        const firmaBaseY = y + height - marginInterno - firmaTextoLineHeight - 5; // Posición base para el texto/línea de la firma

        const firmaX = x + width - marginInterno - firmaMaxWidth; // Alineado a la derecha del recibo

        // Calcular el espacio disponible para el contenido entre la fecha y la firma
        const topContentBoundary = fechaY + 5; // Un poco de espacio debajo de la fecha
        const bottomContentBoundary = firmaBaseY - 5; // Un poco de espacio por encima de la firma
        const maxContentHeight = bottomContentBoundary - topContentBoundary;

        let fontSize = 14; // Tamaño de fuente inicial
        let lineHeightRatio = 1.3; // Relación de interlineado (ej. 1.3 para 14pt * 1.3 = 18.2mm)
        let lineas = [];
        let totalTextoHeight = 0;
        const minFontSize = 8; // Tamaño mínimo de fuente para evitar texto ilegible

        // Bucle para ajustar el tamaño de la fuente y el interlineado si el texto es demasiado largo
        do {
          doc.setFontSize(fontSize);
          lineas = doc.splitTextToSize(textoContenido, contenidoWidth);
          totalTextoHeight = lineas.length * (fontSize * lineHeightRatio);

          if (totalTextoHeight > maxContentHeight && fontSize > minFontSize) {
            fontSize -= 0.5; // Reducir en 0.5pt si el texto es demasiado largo
            lineHeightRatio = Math.max(1.1, lineHeightRatio * 0.95); // Ajustar el interlineado, con un mínimo de 1.1 para no amontonar
          } else {
            break; // El texto cabe o se alcanzó el tamaño mínimo de fuente
          }
        } while (true);

        doc.setFont(undefined, "normal");
        doc.setTextColor(0, 0, 0);

        // Calcular la posición inicial Y para centrar verticalmente el contenido
        const startYContenido = topContentBoundary + (maxContentHeight - totalTextoHeight) / 2;

        for (let i = 0; i < lineas.length; i++) {
          doc.text(
            lineas[i],
            contenidoX,
            startYContenido + i * (fontSize * lineHeightRatio),
            { maxWidth: contenidoWidth, align: "justify" }
          );
        }

        // --- Firma (imagen o línea) y texto de la firma ---
        if (firmaData) {
          // Si hay imagen de firma (sea la guardada o la temporal)
          const dims = await getNaturalImageDimensions(firmaData);
          if (dims.width > 0 && dims.height > 0) {
            const ratio = dims.width / dims.height;
            let firmaDisplayHeight = firmaMaxHeight;
            let firmaDisplayWidth = firmaDisplayHeight * ratio;

            if (firmaDisplayWidth > firmaMaxWidth) {
              firmaDisplayWidth = firmaMaxWidth;
              firmaDisplayHeight = firmaDisplayWidth / ratio;
            }
            const imgPosX = firmaX + (firmaMaxWidth - firmaDisplayWidth) / 2;
            const imgPosY = firmaBaseY - firmaDisplayHeight - 2; // Ajuste para que la firma quede un poco por encima de la línea imaginaria del texto

            doc.addImage(
              firmaData,
              firmaData.startsWith("data:image/png") ? "PNG" : "JPEG",
              imgPosX,
              imgPosY,
              firmaDisplayWidth,
              firmaDisplayHeight,
              undefined,
              "FAST"
            );
          }
        } else if (isSinFirma) {
          // Si es un recibo sin firma virtual (solo línea)
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.5);
          doc.line(firmaX, firmaBaseY, firmaX + firmaMaxWidth, firmaBaseY); // Línea de firma
        } else {
          // Si no hay firma (ni guardada, ni temporal, ni opción sin firma), dibuja una línea por defecto
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.5);
          doc.line(firmaX, firmaBaseY, firmaX + firmaMaxWidth, firmaBaseY); // Línea de firma
        }

        doc.setFontSize(12);
        doc.setFont(undefined, "normal");
        doc.text(firmaTexto, firmaX + firmaMaxWidth / 2, firmaBaseY + firmaTextoLineHeight, {
          align: "center",
        });

        // Marca de agua para copia centrada
        if (esCopia) {
          const copiaText = "COPIA";
          const fontSizeCopia = 80;
          const copiaOpacity = 0.12;
          const centerX = x + width / 2;
          const centerY = y + height / 2 - 15; // Un poco más arriba

          doc.setTextColor(150, 150, 150);
          doc.setFontSize(fontSizeCopia);
          doc.setFont(undefined, "bold");
          doc.setGState(new doc.GState({ opacity: copiaOpacity }));

          doc.saveGraphicsState();
          doc.text(copiaText, centerX, centerY, {
            align: "center",
            baseline: "middle",
            angle: -45,
          });
          doc.restoreGraphicsState();

          doc.setGState(new doc.GState({ opacity: 1 }));
          doc.setTextColor(0, 0, 0);
        }
      }
    </script>
  </body>
</html>
